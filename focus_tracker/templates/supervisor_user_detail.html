{% extends 'base.html' %}

{% block content %}
  
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <a href="{% url 'supervisor_dashboard' %}" class="btn btn-secondary btn-sm mb-2">&larr; Back to User List</a>
      <h2 class="mb-0">
        Focus Dashboard for: {{ target_user.first_name }} {{ target_user.last_name }}
      </h2>
    </div>
    
    <form method="GET" action="{% url 'supervisor_user_detail' target_user.id %}" class="d-flex align-items-center">
      <div class="me-2">
        <label for="start" class="form-label-sm">From:</label>
        <input type="date" class="form-control" 
               id="start" name="start" value="{{ start_date_str }}">
      </div>
      <div class="me-3">
        <label for="end" class="form-label-sm">To:</label>
        <input type="date" class="form-control" 
               id="end" name="end" value="{{ end_date_str }}">
      </div>
      <button type="submit" class="btn btn-primary align-self-end">Filter</button>
    </form>
  </div>


  <div class="row">
    <div class="col-lg-4">
      <div class="summary-card card-focused">
        <h3>{{ focused_percent|floatformat:0 }}%</h3>
        <p>Focused Time</p>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="summary-card card-distracted">
        <h3>{{ distracted_percent|floatformat:0 }}%</h3>
        <p>Distracted Time</p>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="summary-card card-drowsy">
        <h3>{{ drowsy_percent|floatformat:0 }}%</h3>
        <p>Drowsy Time</p>
      </div>
    </div>
  </div>

  <div class="card mt-4">
    <div class="card-header">
      User Focus Timeline (from {{ start_date_str }} to {{ end_date_str }})
    </div>
    <div class="card-body">
      <div style="height: 400px;">
        <canvas id="focusChart" data-chart-min-date="{{ chart_min_date }}"></canvas>
      </div>
    </div>
  </div>

  <script>
    const chartData = {{ chart_data_json|safe }};
    const ctx = document.getElementById('focusChart');
    
    // NEW: Get min date from the canvas data attribute
    const minDate = ctx.dataset.chartMinDate;
    
    const myChart = new Chart(ctx, {
      type: 'line',
      data: {
        datasets: [{
          label: 'Focus Level',
          data: chartData,
          borderColor: 'rgb(75, 192, 192)',
          tension: 0.1,
          stepped: true,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            type: 'time',
            time: {
              unit: 'hour', // Default to hour
              tooltipFormat: 'HH:mm - dd MMM'
            },
            min: minDate, // Set dynamic minimum date
            title: {
              display: true,
              text: 'Time'
            }
          },
          y: {
            title: {
              display: true,
              text: 'Focus State'
            },
            ticks: {
              stepSize: 1,
              callback: function(value, index, ticks) {
                switch (value) {
                  case 0: return 'Drowsy';
                  case 1: return 'Distracted';
                  case 2: return 'Focused';
                }
              }
            },
            min: 0,
            max: 2
          }
        }
      }
    });
  </script>
{% endblock %}