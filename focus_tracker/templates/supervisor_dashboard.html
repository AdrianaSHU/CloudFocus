{% extends "base.html" %}
{% load static %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
  <h2 class="fw-bold" style="color: var(--header-bg);">
      <i class="bi bi-speedometer2 me-2"></i>Classroom Review Panel
  </h2>
  <span class="badge bg-secondary fs-6">Live Analytics</span>
</div>

<div class="card shadow-sm border-0 mb-4">
    <div class="card-header card-header-themed fw-semibold">
        <i class="bi bi-people-fill me-2"></i> Active Session Overview
    </div>
    <div class="card-body text-center p-4">
        <h3 class="display-4 fw-bold text-primary">{{ participant_count }}</h3>
        <h5 class="text-muted">Students Currently "Opted-In"</h5>
        <p class="text-muted mb-0">
            This is an anonymous count of all active participants sending data right now.
        </p>
    </div>
</div>

<div class="row mb-4">
    <div class="col-lg-4 mb-3">
        <div class="card border-0 shadow-sm text-white text-center h-100" 
             style="background: linear-gradient(135deg, #2196f3, #64b5f6);">
            <div class="card-body p-4">
                <h3 class="fw-bold display-5">{{ focused_percent|floatformat:0 }}%</h3>
                <p class="mb-0 fs-5">Class Focus</p>
            </div>
        </div>
    </div>

    <div class="col-lg-4 mb-3">
        <div class="card border-0 shadow-sm text-white text-center h-100" 
             style="background: linear-gradient(135deg, #ff9800, #ffb74d);">
            <div class="card-body p-4">
                <h3 class="fw-bold display-5">{{ distracted_percent|floatformat:0 }}%</h3>
                <p class="mb-0 fs-5">Class Distraction</p>
            </div>
        </div>
    </div>

    <div class="col-lg-4 mb-3">
        <div class="card border-0 shadow-sm text-white text-center h-100" 
             style="background: linear-gradient(135deg, #9c27b0, #ba68c8);">
            <div class="card-body p-4">
                <h3 class="fw-bold display-5">{{ drowsy_percent|floatformat:0 }}%</h3>
                <p class="mb-0 fs-5">Class Drowsiness</p>
            </div>
        </div>
    </div>
</div>

<div class="card border-0 shadow-sm mb-5">
    <div class="card-header card-header-themed fw-semibold">
        <i class="bi bi-graph-up"></i> Live Classroom Trends (Last 100 Logs)
    </div>
    <div class="card-body">
        {% if total_logs > 0 %}
            <div id="supervisorChart" style="height: 400px;"></div>
        {% else %}
            <div class="alert alert-info text-center">
                <i class="bi bi-info-circle me-2"></i> 
                No data is being recorded. This chart will update when students start a session.
            </div>
        {% endif %}
    </div>
</div>

{% if request.user.is_superuser %}
<div class="card border-0 shadow-sm mb-5">
    <div class="card-header card-header-themed fw-semibold d-flex justify-content-between align-items-center">
        <span><i class="bi bi-shield-lock-fill me-2"></i>Admin User Management</span>
        <span class="badge bg-light text-dark">{{ all_users.count }} Users</span>
    </div>
    <div class="card-body">
        <div class="alert alert-warning py-2 small">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <strong>Admin Only:</strong> You have full access to manage user accounts. Deleting a user is permanent.
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>User</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Date Joined</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for u in all_users %}
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <img src="{% if u.profile.profile_picture %}{{ u.profile.profile_picture.url }}{% else %}{% static 'images/default.png' %}{% endif %}" 
                                     class="rounded-circle me-3 border" 
                                     style="width: 40px; height: 40px; object-fit: cover;">
                                <div>
                                    <div class="fw-bold">{{ u.first_name }} {{ u.last_name }}</div>
                                    <div class="small text-muted">@{{ u.username }}</div>
                                </div>
                            </div>
                        </td>
                        <td>{{ u.email }}</td>
                        <td>
                            {% if u.is_superuser %}
                                <span class="badge bg-danger">Admin</span>
                            {% elif u.is_staff %}
                                <span class="badge bg-warning text-dark">Staff</span>
                            {% else %}
                                <span class="badge bg-info text-dark">Student</span>
                            {% endif %}
                        </td>
                        <td>{{ u.date_joined|date:"d M Y" }}</td>
                        <td class="text-end">
                            {% if u != request.user %}
                                <form method="POST" action="{% url 'delete_user' u.id %}" class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-outline-danger btn-sm" 
                                            onclick="return confirm('Are you sure you want to DELETE user {{ u.username }}? This cannot be undone.');">
                                        <i class="bi bi-trash-fill"></i> Delete
                                    </button>
                                </form>
                            {% else %}
                                <span class="text-muted small fst-italic pe-2">Current User</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
  const getThemeColors = () => {
      const root = document.documentElement;
      const styles = getComputedStyle(root);
      const currentTheme = root.getAttribute('data-theme');
      
      let textColor = '#000000'; 
      let borderColor = styles.getPropertyValue('--border-color').trim();
      
      if (currentTheme === 'dark') {
          textColor = '#ffffff'; 
          if (!borderColor || borderColor === '#30363d') borderColor = '#444444'; 
      }
      let lineColor = styles.getPropertyValue('--link-color').trim();
      return { textColor, lineColor, borderColor };
  };

  const chartDataRaw = '{{ chart_data_json|escapejs }}';
  const chartData = chartDataRaw ? JSON.parse(chartDataRaw) : [];
  
  if (chartData.length > 0) {
      const colors = getThemeColors();

      const trace = {
        x: chartData.map(d => d.x),
        y: chartData.map(d => d.y),
        mode: 'markers',
        type: 'scatter',
        marker: { 
            size: 10,
            color: chartData.map(d => {
                if(d.y === 2) return '#2ecc71'; 
                if(d.y === 1) return '#f1c40f'; 
                return '#e74c3c';               
            }),
            opacity: 0.7,
            line: { width: 1, color: colors.borderColor }
        },
        name: 'Student State'
      };
      
      const layout = {
        paper_bgcolor: 'rgba(0,0,0,0)', 
        plot_bgcolor: 'rgba(0,0,0,0)',  
        font: { 
            color: colors.textColor, 
            family: '"Inter", sans-serif'
        },
        margin: { t: 30, b: 40, l: 60, r: 20 }, 
        xaxis: { 
          title: 'Time', 
          type: 'date', 
          gridcolor: colors.borderColor, 
          tickfont: { color: colors.textColor }
        },
        yaxis: { 
          title: 'Class State',
          tickvals: [0, 1, 2], 
          ticktext: ['Drowsy', 'Distracted', 'Focused'], 
          range: [-0.5, 2.5], 
          gridcolor: colors.borderColor,
          tickfont: { color: colors.textColor }
        }
      };

      Plotly.newPlot('supervisorChart', [trace], layout, {responsive: true});
  }
</script>

{% endblock %}