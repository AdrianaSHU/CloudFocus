{% extends 'base.html' %}

{% block content %}
  <h2 class="mb-4">Welcome to your Dashboard, {{ user.username }}!</h2>

  <!-- (1) Session Management Card -->
  <div class="card mb-4">
    <div class="card-header">
      <span>Session Management</span>
    </div>
    <div class="card-body">
      
      <!-- This logic checks if the user has an active session -->
      {% if active_session %}
      
        <!-- If session is ACTIVE, show this: -->
        <h5 class="text-success">Session Active</h5>
        <p>You are currently "Checked In" to the device: 
          <strong>{{ active_session.device.name }}</strong>
        </p>
        <p>All data from this device is being saved to your account.</p>
        
        <!-- End Session Button -->
        <form method="POST" action="{% url 'end_session' %}">
          {% csrf_token %}
          <button type="submit" class="btn btn-outline-danger">End My Session</button>
        </form>
        
      {% else %}
      
        <!-- If session is INACTIVE, show this: -->
        <h5 class="text-danger">You have no active session.</h5>
        <p>Please select a device to "Check In" and start recording data.</p>
        
        <div class="list-group">
          {% for device in all_devices %}
            <div class="list-group-item d-flex justify-content-between align-items-center">
              <strong>{{ device.name }}</strong>
              <!-- Start Session Button -->
              <form method="POST" action="{% url 'start_session' device.id %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-success">Start Session</button>
              </form>
            </div>
          {% empty %}
            <p class="text-muted">No devices are registered in the system. Please contact your supervisor.</p>
          {% endfor %}
        </div>
        
      {% endif %}
      
    </div>
  </div>

  <!-- === (2) UPDATED SENSOR DATA ROW === -->
  <div class="row">
    <div class="col-lg-6">
      <!-- Changed style to 'warning' color -->
      <div class="summary-card" style="background-color: #ffa726;"> <!-- Orange -->
        <h3>
          {% if latest_log and latest_log.temperature is not None %}
            {{ latest_log.temperature|floatformat:1 }}Â°C
          {% else %}
            --
          {% endif %}
        </h3>
        <p>Device Temperature</p>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="summary-card" style="background-color: #66bb6a;"> <!-- Greenish -->
        <h3>
          {% if latest_log and latest_log.humidity is not None %}
            {{ latest_log.humidity|floatformat:1 }}%
          {% else %}
            --
          {% endif %}
        </h3>
        <p>Device Humidity</p>
      </div>
    </div>
  </div>

  <!-- (3) Summary Cards -->
  <div class="row">
    <div class="col-lg-4">
      <div class="summary-card card-focused">
        <h3>{{ focused_percent|floatformat:0 }}%</h3>
        <p>Focused Time</p>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="summary-card card-distracted">
        <h3>{{ distracted_percent|floatformat:0 }}%</h3>
        <p>Distracted Time</p>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="summary-card card-drowsy">
        <h3>{{ drowsy_percent|floatformat:0 }}%</h3>
        <p>Drowsy Time</p>
      </div>
    </div>
  </div>

  <!-- (4) Focus Timeline Chart -->
  <div class="card mt-4">
    <div class="card-header">
      Your Focus Timeline
    </div>
    <div class="card-body">
      <div style="height: 400px;">
        <canvas id="focusChart"></canvas>
      </div>
    </div>
  </div>

  <!-- (5) Chart.js Script -->
  <script>
    // Get the data from our Django view
    const chartData = {{ chart_data_json|safe }};

    const ctx = document.getElementById('focusChart').getContext('2d');
    const myChart = new Chart(ctx, {
      type: 'line',
      data: {
        datasets: [{
          label: 'Focus Level',
          data: chartData,
          borderColor: 'rgb(75, 192, 192)',
          tension: 0.1,
          stepped: true, // Shows changes as "blocks", good for status data
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            type: 'time', // Use the time scale
            time: {
              unit: 'minute', // Display time by the minute
              tooltipFormat: 'HH:mm:ss'
            },
            title: {
              display: true,
              text: 'Time'
            }
          },
          y: {
            title: {
              display: true,
              text: 'Focus State'
            },
            // This configures the Y-axis labels
            ticks: {
              stepSize: 1,
              callback: function(value, index, ticks) {
                // Show text labels instead of numbers
                switch (value) {
                  case 0:
                    return 'Drowsy';
                  case 1:
                    return 'Distracted';
                  case 2:
                    return 'Focused';
                }
              }
            },
            min: 0,
            max: 2 // Set strict min/max for our 3 states
          }
        }
      }
    });
  </script>
{% endblock %}